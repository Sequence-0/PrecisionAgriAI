<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FHB Disease Classification</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  </head>
<body>
    <div class="d-flex" id="wrapper">
      <!-- Sidebar -->
      <div class="bg-dark border-right" id="sidebar-wrapper">
        <div class="sidebar-heading text-white">Crop Disease AI</div>
        <div class="list-group list-group-flush">
          <a href="/" class="list-group-item list-group-item-action bg-dark text-white"><i class="fas fa-leaf mr-2"></i>FHB Disease Classification</a>
          <a href="/insights" class="list-group-item list-group-item-action bg-dark text-white"><i class="fas fa-chart-line mr-2"></i>Insights</a>
        </div>
      </div>
      <!-- Page Content -->
      <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
          <button class="btn btn-primary" id="menu-toggle">
            <i class="fas fa-bars"></i>
          </button>
        </nav>
        <div class="container-fluid mt-5">
          <h1 class="mb-4 text-white">FHB Disease Classification</h1>
          <form id="upload-form" action="/predict" method="post" enctype="multipart/form-data" class="w-100">
            <div class="custom-file mb-3">
              <input type="file" class="custom-file-input" id="file-input" name="file" accept="image/tiff" onchange="previewImage(event)">
              <label class="custom-file-label file-label" for="file-input">Choose a TIFF Image</label>
            </div>
          <img id="image-preview" src="#" alt="Image Preview" class="img-fluid rounded mb-3" style="display:none; max-height: 200px;"/>
            <button type="submit" id="submit-btn" class="btn btn-success btn-lg" disabled>Upload and Predict</button>
          </form>
          <div id="last-uploaded-info" class="mt-3" style="display:none;">
            <h5 class="text-white">Last Uploaded Image: <span id="last-uploaded-filename"></span></h5>
          </div>
          <div class="spinner-border text-primary mt-4" role="status" id="spinner" style="display:none;">
            <span class="sr-only">Loading...</span>
          </div>
          <div id="result" class="mt-4 h4 font-weight-bold"></div>
          <div id="index-graphs" class="mt-4 w-100">
            <img id="ndvi-image" src="#" alt="NDVI" class="img-fluid rounded mb-3" style="display:none;"/>
            <img id="rx-image" src="#" alt="RX Anomaly" class="img-fluid rounded" style="display:none;"/>
          </div>
        </div>
      </div>
    </div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
      });

      const uploadForm = document.getElementById('upload-form');
      const fileInput = document.getElementById('file-input');
      const submitBtn = document.getElementById('submit-btn');
      const resultDiv = document.getElementById('result');
      const spinner = document.getElementById('spinner');
      const imagePreview = document.getElementById('image-preview');
      const ndviImage = document.getElementById('ndvi-image');
      const rxImage = document.getElementById('rx-image');
      const fileLabel = document.querySelector('.custom-file-label');

      function previewImage(event) {
        if (event.target.files.length > 0) {
          const src = URL.createObjectURL(event.target.files[0]);
          imagePreview.src = src;
          imagePreview.style.display = 'block';
          submitBtn.disabled = false;
          // Update custom file input label
          fileLabel.innerText = event.target.files[0].name;
          document.getElementById('last-uploaded-info').style.display = 'none'; // Hide last uploaded info if new file is chosen
        } else {
          imagePreview.style.display = 'none';
          submitBtn.disabled = true;
          fileLabel.innerText = 'Choose a TIFF Image';
        }
      }

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        resultDiv.innerText = '';
        ndviImage.style.display = 'none';
        rxImage.style.display = 'none';
        spinner.style.display = 'block';
        submitBtn.disabled = true;

        const formData = new FormData(e.target);
        
        try {
          const response = await fetch('/predict', {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            resultDiv.innerText = `Error: ${result.error}`;
          } else {
            resultDiv.innerText = `Prediction: ${result.prediction}`;
            ndviImage.src = result.ndvi_image + '?t=' + new Date().getTime();
            rxImage.src = result.rx_anomaly_image + '?t=' + new Date().getTime();
            ndviImage.style.display = 'block';
            rxImage.style.display = 'block';
          }

        } catch (error) {
          resultDiv.innerText = `An error occurred: ${error.message}`;
        } finally {
          spinner.style.display = 'none';
          submitBtn.disabled = true; // Disable until new file is chosen
          fileInput.value = ''; // Reset file input
          imagePreview.style.display = 'none'; // Hide preview
          document.getElementById('last-uploaded-info').style.display = 'none'; // Hide last uploaded info
        }
      });

      // Function to display previous prediction data
      async function displayLastPrediction() {
        spinner.style.display = 'block'; // Show spinner while loading
        try {
          const response = await fetch('/get_last_prediction_data');
          if (!response.ok) {
            throw new Error('No previous prediction data found');
          }
          const data = await response.json();

          // Display original image preview
          if (data.original_filepath) {
            imagePreview.src = data.original_filepath; // Assuming Flask serves files from 'uploads'
            imagePreview.style.display = 'block';
            document.getElementById('last-uploaded-filename').innerText = data.original_filename;
            document.getElementById('last-uploaded-info').style.display = 'block';
            fileLabel.innerText = data.original_filename; // Update file input label
          }

          // Display prediction result
          resultDiv.innerText = `Prediction: ${data.prediction}`;
          
          // Display generated images
          ndviImage.src = data.ndvi_image;
          rxImage.src = data.rx_anomaly_image;
          ndviImage.style.display = 'block';
          rxImage.style.display = 'block';
          submitBtn.disabled = false; // Enable submit button if there's previous data
        } catch (error) {
          console.log("No previous prediction data to display:", error.message);
          // Keep elements hidden if no data
          resultDiv.innerText = '';
          ndviImage.style.display = 'none';
          rxImage.style.display = 'none';
          imagePreview.style.display = 'none'; // Hide original image preview
          document.getElementById('last-uploaded-info').style.display = 'none';
          submitBtn.disabled = true;
          fileLabel.innerText = 'Choose a TIFF Image'; // Reset file input label
        } finally {
          spinner.style.display = 'none'; // Hide spinner after loading
        }
      }

      // Call on page load
      window.addEventListener('load', displayLastPrediction);
    </script>
  </body>
</html>
